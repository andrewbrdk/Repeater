<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Repeater</title>
	<style>
		body {
			margin-left: 10%;
			margin-right: 10%;
		}
		h1 {
			text-align: center;
		}
		h1 a {
			color: black;
			text-decoration: none;
		}
		.job {
			margin-bottom: 20px;
			overflow-x: auto;
			overflow-y: hidden;
		}
		table {
			width: 100%;
		}
		table th {
			font-size: 1.2em;
			font-weight: normal;
			text-align: left;
			margin-bottom: 10px;
		}
		th.collapse_btn, td.collapse_btn {
			width: 2rem;
			min-width: 2rem;
			position: sticky;
			left: 0;
			background-color: white;
		}
		th.task_names, td.task_names {
			width: 15rem;
			min-width: 15rem;
			position: sticky;
			left: 2rem;
			background-color: white;
			/* overflow */
			/* todo: show full names on hover */
			max-width: 15rem;
 			overflow: hidden;
 			text-overflow: ellipsis;
 			white-space: nowrap;
		}
		th.states, td.states {
			vertical-align: middle;
			text-align: center;
			width: 1.2rem;
		}
		th.selected, td.selected {
			border-bottom-style: solid;
			border-width: medium;
		}
		th.schedule, td.schedule {
			width: 10rem;
			min-width: 10rem;
			text-align: right;
			position: sticky;
			right: 10rem;
			background-color: white;
		}
		th.runnow_btn, td.runnow_btn {
			width: 5rem;
			min-width: 5rem;
			text-align: right;
			position: sticky;
			right: 5rem;
			background-color: white;
		}
		th.onoff_btn, td.onoff_btn {
			width: 5rem;
			min-width: 5rem;
			text-align: right;
			position: sticky;
			right: 0;
			background-color: white;
		}
		table a {
			color: black;
			text-decoration: none;
		}
		pre {
			background-color: #eee;
			font-family: courier, monospace;
			padding: 0 3px;
			display: block;
			font-size: 1.2em;
		}
	</style>
</head>
<body>
    <h1><a href="/">Repeater</a></h1>
    <div id="alljobs">
        <!-- dynamic rendering -->
    </div>
	<script>
		let selected = {
			job: null,
			run: null,
			task: null
		};
		function fetchJobs() {
			fetch('/jobs')
				.then(response => {
					return response.json();
				}).then(data => {
            		renderAllJobs(data);
        		})
				.catch(error => {
					console.error('Error fetching jobs:', error);
			});
        }
		function renderAllJobs(jobs) {
            const alljobs = document.getElementById('alljobs');
			//todo: avoid flash https://stackoverflow.com/a/1392278
            alljobs.replaceChildren();
            jobs['Jobs'].forEach((job, jobIndex) => {
                const jobDiv = document.createElement('div');
                jobDiv.classList.add('job');
				jobDiv.id = `job${jobIndex}`;
				jobDiv.innerHTML = jobHTML(job, jobIndex);
				alljobs.appendChild(jobDiv);
            });
        }
		function jobHTML(job, jobIndex) {
    		let job_html = `
				<table>
				<tr>
				<th class="collapse_btn"><button id="showhidebtn${jobIndex}" onclick="showHide(${jobIndex})">+</button></th>
    			<th class="task_names"><strong>${job.Title}</strong></th>`;
        	job.RunHistory.forEach((run, runIndex) => {
				job_html += `
					<th id="job${jobIndex}run${runIndex}" class="states">
					<a href="/#job${jobIndex}" onclick="selectRun(${jobIndex}, ${runIndex}, null);return false;">${getHTMLStatus(run.Status)}</a>
					</th>`;
    		});
			job_html += `
				<th class="states">□</th>
        		<th class="fill"> </th>
				<th class="schedule">${job.HCron}</th>
        		<th class="runnow_btn"><button onclick="runNow(${jobIndex})">Run Now</button></th>
        		<th class="onoff_btn"><button onclick="onOff(${jobIndex})">${job.OnOff ? 'Turn Off' : 'Turn On'}</button></th>
        		</tr>`;
			job.Tasks.forEach((task, taskIndex) => {
            	job_html += `
					<tr class="hist${jobIndex}" style="visibility: collapse;">
           	 		<td class="collapse_btn"> </td>
					<td class="task_names">${task.Name}</td>`;
        		job.RunHistory.forEach((run, runIndex) => {
        	    	job_html += `
						<td id="job${jobIndex}run${runIndex}task${taskIndex}" class="states">
						<a href="/#job${jobIndex}" onclick="selectRun(${jobIndex}, ${runIndex}, ${taskIndex});return false;">${getHTMLStatus(run.TasksHistory[taskIndex].Status)}</a>
						</td>`;
    			});
			    job_html += `
					<td class="states">□</td>
					<td class="fill"> </td>
		    		<td class="schedule"> </td>
		    		<td class="runnow_btn"> </td>
		    		<td class="onoff_btn"> </td>
					</tr>`;
			});
			job_html += `
				</table>
				</div>`;
			job_html += `
				<p class="info_job${jobIndex}" style="display: none;">
				<button>Restart job</button>
				</p>
				<p class="info_job${jobIndex}" style="display: none;">
				<button>Restart task</button>
 				</p>
				<pre class="info_job${jobIndex}" style="display: none;">
				<code>&gt; cmd </code>
 				<samp> output </samp>
 				</pre>`;
			//job_html += `${run.ScheduledTime}:`
			//job_html += `<button onclick="restart( ${td.job_idx}, ${td.run_idx}, ${td.cmd_idx} )">Restart job</button>`
			//job_html += `${cmd_run.Name}:`
 			//job_html += `<button onclick="restart( ${td.job_idx}, ${td.run_idx}, ${td.cmd_idx} )">Restart task</button>`
			//job_html += `<code>> ${cmd_run.RenderedCmd} </code>\n`
 			//job_html += `<samp> ${cmd_run.lastOutput} </samp>`
			return job_html;
		}
		function getHTMLStatus(runStatus) {
			// "&#9632;", "&Cross;", "&#9704;" "&#9633;"
			const statusSymbols = ['■', '⨯', '◨', '□'];
			return statusSymbols[runStatus] || '?';
		}
		function selectRun(jobIndex, runIndex, taskIndex) {
			clearSelected();
			selected = {
				job: jobIndex,
				run: runIndex,
				task: taskIndex
			};
			restoreSelected();
		}
		function clearSelected(){
			if (selected.job !== null && selected.run !== null && selected.task !== null){
				e = document.getElementById(`job${selected.job}run${selected.run}task${selected.task}`)
				e.classList.remove('selected');
			} else if (selected.job !== null && selected.run !== null && selected.task === null) {
				e = document.getElementById(`job${selected.job}run${selected.run}`)
				e.classList.remove('selected');
			}
		}
		function restoreSelected(){
			if (selected.job !== null && selected.run !== null && selected.task !== null){
				e = document.getElementById(`job${selected.job}run${selected.run}task${selected.task}`)
				e.classList.add('selected');
			} else if (selected.job !== null && selected.run !== null && selected.task === null) {
				e = document.getElementById(`job${selected.job}run${selected.run}`)
				e.classList.add('selected');
			}
		}
		function onOff(job) {
			fetch('/onoff?job=' + job)
				.then(response => {
					fetchJobs();
				})
				.catch(error => {
					console.error('Error toggling state:', error);
				});
		}
		function runNow(job) {
			fetch('/runnow?job=' + job)
				.then(response => {
					fetchJobs();
				})
				.catch(error => {
					console.error('Error starting job:', error);
			});
		}
		function restart(job, run, cmd) {
			fetch('/restart?job=' + job + '&run=' + run + '&cmd=' + cmd)
				.then(response => {
					fetchJobs();
				})
				.catch(error => {
					console.error('Error restarting job:', error);
				});
		}
		function showHide(job) {
			for (const e of document.querySelectorAll('.hist' + job)) {
        		if ( e.style.visibility == 'visible' )
            		e.style.visibility = 'collapse';
        		else
            		e.style.visibility = 'visible';
			}
			for (const e of document.querySelectorAll('.info_job' + job)) {
				if (e.style.display === "none") {
					e.style.display = "block";
				} else {
					e.style.display = "none";
				}
			}
			var b = document.getElementById('showhidebtn' + job);
			if (b.innerText == '-')
				b.innerText = '+';
			else 
				b.innerText = '-';
		}
        
        fetchJobs();

		document.addEventListener("DOMContentLoaded", function() {
			for (const e of document.querySelectorAll('.job')) {
				e.scrollLeft = e.scrollWidth;
			}
		});
	</script>
</body>
</html>