<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Repeater</title>
	<style>
		body {
			margin-left: 10%;
			margin-right: 10%;
		}
		h1 {
			text-align: center;
		}
		h1 a {
			color: black;
			text-decoration: none;
		}
		.job {
			margin-bottom: 20px;
			overflow-x: auto;
			overflow-y: hidden;
		}
		table {
			width: 100%;
		}
		table th {
			font-size: 1.2em;
			font-weight: normal;
			text-align: left;
			margin-bottom: 10px;
		}
		th.collapse_btn, td.collapse_btn {
			width: 2rem;
			min-width: 2rem;
			position: sticky;
			left: 0;
			background-color: white;
		}
		th.task_names, td.task_names {
			width: 15rem;
			min-width: 15rem;
			position: sticky;
			left: 2rem;
			background-color: white;
			/* overflow */
			/* todo: show full names on hover */
			max-width: 15rem;
 			overflow: hidden;
 			text-overflow: ellipsis;
 			white-space: nowrap;
		}
		th.states, td.states {
			vertical-align: middle;
			text-align: center;
			width: 1.2rem;
		}
		th.selected, td.selected {
			border-bottom-style: solid;
			border-width: medium;
		}
		th.schedule, td.schedule {
			width: 10rem;
			min-width: 10rem;
			text-align: right;
			position: sticky;
			right: 10rem;
			background-color: white;
		}
		th.runnow_btn, td.runnow_btn {
			width: 5rem;
			min-width: 5rem;
			text-align: right;
			position: sticky;
			right: 5rem;
			background-color: white;
		}
		th.onoff_btn, td.onoff_btn {
			width: 5rem;
			min-width: 5rem;
			text-align: right;
			position: sticky;
			right: 0;
			background-color: white;
		}
		table a {
			color: black;
			text-decoration: none;
		}
		pre {
			background-color: #eee;
			font-family: courier, monospace;
			padding: 0 3px;
			display: block;
			font-size: 1.2em;
		}
	</style>
</head>
<body>
    <h1><a href="/">Repeater</a></h1>
    <div id="alljobs">
        <!-- dynamic rendering -->
    </div>
	<script>
		function fetchJobs() {
			fetch('/jobs')
				.then(response => {
					return response.json();
				}).then(data => {
            		renderAllJobs(data);
        		})
				.catch(error => {
					console.error('Error fetching jobs:', error);
			});
        }
		function renderAllJobs(jobs) {
            const alljobs = document.getElementById('alljobs');
			//todo: avoid flash https://stackoverflow.com/a/1392278
            alljobs.replaceChildren();
            jobs['Jobs'].forEach((job, jobIndex) => {
                const jobDiv = document.createElement('div');
                jobDiv.classList.add('job');
				jobDiv.id = `job${jobIndex}`;
				jobDiv.innerHTML = jobHTML(job, jobIndex);
				alljobs.appendChild(jobDiv);
            });
        }
		function jobHTML(job, jobIndex) {
			//let btnText = jb.CountFailed() > 0 || td.job_idx === jobIndex ? '-' : '+';
			let btnText = '-';
			//let visibilityStyle = jb.CountFailed() > 0 || td.job_idx === jobIndex ? 'visible' : 'collapse';
			let visibilityStyle = 'visible';

    		let job_html = `<table>\n<tr>\n`;
			job_html += `<th class="collapse_btn"><button id="showhidebtn${jobIndex}" onclick="showhide(${jobIndex})">${btnText}</button></th>`;
    		job_html += `<th class="task_names"><strong>${job.Title}</strong></th>`;
			
        	job.RunHistory.forEach((run, runIndex) => {
        		//let selectedClass = (td.job_idx === jobIndex && td.run_idx === runIndex && td.cmd_idx === -1) ? 'selected' : '';
        		let selectedClass = '';
				job_html += `<th class="states ${selectedClass}">`;
				job_html += `<a href="/?job=${jobIndex}&run=${runIndex}#job${jobIndex}">${getHTMLStatus(run.Status)}</a>`;
				job_html += `</th>`;
    		});
			
			job_html += `<th class="states">&#9633;</th>`;
        	job_html += `<th class="fill"> </th>`;
			
			//let cronText = getCronDescription(job.Cron);
        	job_html += `<th class="schedule">${job.HCron}</th>`;
        	job_html += `<th class="runnow_btn"><button onclick="runnow(${jobIndex})">Run Now</button></th>`;
        	job_html += `<th class="onoff_btn"><button onclick="onoff(${jobIndex})">${job.OnOff ? 'Turn Off' : 'Turn On'}</button></th>`;
        	job_html += `</tr>\n`;

			job.Tasks.forEach((task, taskIndex) => {
            	job_html += `<tr class="hist${jobIndex}" style="visibility: ${visibilityStyle};">\n`;
           	 	job_html += `<td class="collapse_btn"> </td>`;
				job_html += `<td class="task_names">${task.Name}</td>`;
				
        		job.RunHistory.forEach((run, runIndex) => {
        		    //let selectedClass = (td.job_idx === jobIndex && td.run_idx === runIndex && td.cmd_idx === taskIndex) ? 'selected' : '';
					let selectedClass = '';
        	    	job_html += `<td class="states ${selectedClass}">`;
					job_html += `<a href="/?job=${jobIndex}&run=${runIndex}&cmd=${taskIndex}#job${jobIndex}">${getHTMLStatus(run.TasksHistory[taskIndex].Status)}</a>`;
					job_html += `</td>`;
    			});
				
			    job_html += `<td class="states">&#9633;</td>`;
				job_html += `<td class="fill"> </td>`;
		    	job_html += `<td class="schedule"> </td>`;
		    	job_html += `<td class="runnow_btn"> </td>`;
		    	job_html += `<td class="onoff_btn"> </td>\n`;
				job_html += `</tr>\n`;
			});
			job_html += `</table>\n</div>\n`;
			return job_html;
		}
		function getHTMLStatus(runStatus) {
			// "&#9632;", "&Cross;", "&#9704;" "&#9633;"
			const statusSymbols = ['■', '⨯', '◨', '□'];
			return statusSymbols[runStatus] || '?';
		}
		function onoff(job) {
			fetch('/onoff?job=' + job)
				.then(response => {
					fetchJobs();
				})
				.catch(error => {
					console.error('Error toggling state:', error);
				});
		}
		function runnow(job) {
			fetch('/runnow?job=' + job)
				.then(response => {
					fetchJobs();
				})
				.catch(error => {
					console.error('Error starting job:', error);
			});
		}
		function restart(job, run, cmd) {
			fetch('/restart?job=' + job + '&run=' + run + '&cmd=' + cmd)
				.then(response => {
					fetchJobs();
				})
				.catch(error => {
					console.error('Error restarting job:', error);
				});
		}
		function showhide(job) {
			for (const e of document.querySelectorAll('.hist' + job)) {
        		if ( e.style.visibility == 'visible' )
            		e.style.visibility = 'collapse';
        		else
            		e.style.visibility = 'visible';
			}
			var b = document.getElementById('showhidebtn' + job);
			if (b.innerText == '-')
				b.innerText = '+';
			else 
				b.innerText = '-';
		}
        
        fetchJobs();

		document.addEventListener("DOMContentLoaded", function() {
			for (const e of document.querySelectorAll('.job')) {
				e.scrollLeft = e.scrollWidth;
			}
		});
	</script>
</body>
</html>